{
  "measure": "CMS125",
  "version": "10.2.000",
  "description": "SQL translations of CMS125 CQL measure populations",
  "queries": [
    {
      "name": "initial_population",
      "description": "Women aged 51-74 years",
      "cql": "AgeInYearsAt(start of \"Measurement Period\") >= 51 and AgeInYearsAt(start of \"Measurement Period\") < 75 and Patient.gender = 'female'",
      "sql": "SELECT DISTINCT p.id AS patient_id, p.name_family, p.gender, p.birthdate, TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) AS age_years FROM workspace.default.patient p WHERE p.gender = 'female' AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) >= 51 AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) < 75 AND p.active = true",
      "viewName": "cms125_initial_population"
    },
    {
      "name": "qualifying_encounters",
      "description": "Encounters within the measurement period (last 2 years)",
      "cql": "[Encounter: \"Office Visit\"] E where E.status = 'finished' and E.period during \"Measurement Period\"",
      "sql": "SELECT DISTINCT e.patient_id, e.id AS encounter_id, e.type_code, e.type_display, e.period_start, e.period_end FROM workspace.default.encounter e WHERE e.status = 'finished' AND e.period_start >= ADD_MONTHS(CURRENT_DATE(), -24)",
      "viewName": "cms125_qualifying_encounters"
    },
    {
      "name": "mammography_performed",
      "description": "Mammography observations within 27 months",
      "cql": "[Observation: \"Mammography\"] M where M.status = 'final' and M.effective during 27 months or less before end of \"Measurement Period\"",
      "sql": "SELECT DISTINCT o.patient_id, o.id AS observation_id, o.code_system, o.code_code, o.code_display, o.effective_datetime, DATEDIFF(MONTH, o.effective_datetime, CURRENT_DATE()) AS months_since_mammography FROM workspace.default.observation o WHERE o.status = 'final' AND o.code_system = 'http://loinc.org' AND o.code_code = '24606-6' AND o.effective_datetime >= ADD_MONTHS(CURRENT_DATE(), -27)",
      "viewName": "cms125_mammography_performed"
    },
    {
      "name": "denominator",
      "description": "Initial Population with Qualifying Encounters",
      "cql": "\"Initial Population\" and exists \"Qualifying Encounters\"",
      "sql": "SELECT DISTINCT ip.patient_id, ip.name_family, ip.age_years FROM (SELECT DISTINCT p.id AS patient_id, p.name_family, TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) AS age_years FROM workspace.default.patient p WHERE p.gender = 'female' AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) >= 51 AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) < 75 AND p.active = true) ip INNER JOIN (SELECT DISTINCT e.patient_id FROM workspace.default.encounter e WHERE e.status = 'finished' AND e.period_start >= ADD_MONTHS(CURRENT_DATE(), -24)) qe ON ip.patient_id = qe.patient_id",
      "viewName": "cms125_denominator"
    },
    {
      "name": "denominator_exclusion",
      "description": "Patients with bilateral mastectomy",
      "cql": "[Procedure: \"Bilateral Mastectomy\"] P where P.status = 'completed'",
      "sql": "SELECT DISTINCT pr.patient_id FROM workspace.default.procedure pr WHERE pr.status = 'completed' AND pr.code_system = 'http://snomed.info/sct' AND pr.code_code = '27865001'",
      "viewName": "cms125_denominator_exclusion"
    },
    {
      "name": "numerator",
      "description": "Denominator patients with mammography performed",
      "cql": "exists \"Mammography Performed\"",
      "sql": "SELECT DISTINCT d.patient_id, d.name_family, d.age_years FROM (SELECT DISTINCT ip.patient_id, ip.name_family, ip.age_years FROM (SELECT DISTINCT p.id AS patient_id, p.name_family, TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) AS age_years FROM workspace.default.patient p WHERE p.gender = 'female' AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) >= 51 AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) < 75 AND p.active = true) ip INNER JOIN (SELECT DISTINCT e.patient_id FROM workspace.default.encounter e WHERE e.status = 'finished' AND e.period_start >= ADD_MONTHS(CURRENT_DATE(), -24)) qe ON ip.patient_id = qe.patient_id) d INNER JOIN (SELECT DISTINCT o.patient_id FROM workspace.default.observation o WHERE o.status = 'final' AND o.code_system = 'http://loinc.org' AND o.code_code = '24606-6' AND o.effective_datetime >= ADD_MONTHS(CURRENT_DATE(), -27)) mp ON d.patient_id = mp.patient_id",
      "viewName": "cms125_numerator"
    },
    {
      "name": "measure_report",
      "description": "Population counts and performance rate",
      "cql": "Summary of all populations",
      "sql": "WITH population_counts AS (SELECT 'initial-population' AS population_type, COUNT(DISTINCT patient_id) AS count, 1 AS sort_order FROM (SELECT DISTINCT p.id AS patient_id FROM workspace.default.patient p WHERE p.gender = 'female' AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) >= 51 AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) < 75 AND p.active = true) UNION ALL SELECT 'denominator' AS population_type, COUNT(DISTINCT patient_id) AS count, 2 AS sort_order FROM (SELECT DISTINCT ip.patient_id FROM (SELECT DISTINCT p.id AS patient_id FROM workspace.default.patient p WHERE p.gender = 'female' AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) >= 51 AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) < 75 AND p.active = true) ip INNER JOIN (SELECT DISTINCT e.patient_id FROM workspace.default.encounter e WHERE e.status = 'finished' AND e.period_start >= ADD_MONTHS(CURRENT_DATE(), -24)) qe ON ip.patient_id = qe.patient_id LEFT JOIN (SELECT DISTINCT pr.patient_id FROM workspace.default.procedure pr WHERE pr.status = 'completed' AND pr.code_system = 'http://snomed.info/sct' AND pr.code_code = '27865001') ex ON ip.patient_id = ex.patient_id WHERE ex.patient_id IS NULL) UNION ALL SELECT 'denominator-exclusion' AS population_type, COUNT(DISTINCT patient_id) AS count, 3 AS sort_order FROM (SELECT DISTINCT pr.patient_id FROM workspace.default.procedure pr WHERE pr.status = 'completed' AND pr.code_system = 'http://snomed.info/sct' AND pr.code_code = '27865001') UNION ALL SELECT 'numerator' AS population_type, COUNT(DISTINCT patient_id) AS count, 4 AS sort_order FROM (SELECT DISTINCT d.patient_id FROM (SELECT DISTINCT ip.patient_id FROM (SELECT DISTINCT p.id AS patient_id FROM workspace.default.patient p WHERE p.gender = 'female' AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) >= 51 AND TIMESTAMPDIFF(YEAR, p.birthdate, CURRENT_DATE()) < 75 AND p.active = true) ip INNER JOIN (SELECT DISTINCT e.patient_id FROM workspace.default.encounter e WHERE e.status = 'finished' AND e.period_start >= ADD_MONTHS(CURRENT_DATE(), -24)) qe ON ip.patient_id = qe.patient_id LEFT JOIN (SELECT DISTINCT pr.patient_id FROM workspace.default.procedure pr WHERE pr.status = 'completed' AND pr.code_system = 'http://snomed.info/sct' AND pr.code_code = '27865001') ex ON ip.patient_id = ex.patient_id WHERE ex.patient_id IS NULL) d INNER JOIN (SELECT DISTINCT o.patient_id FROM workspace.default.observation o WHERE o.status = 'final' AND o.code_system = 'http://loinc.org' AND o.code_code = '24606-6' AND o.effective_datetime >= ADD_MONTHS(CURRENT_DATE(), -27)) mp ON d.patient_id = mp.patient_id)) SELECT population_type, count, CASE WHEN population_type = 'numerator' THEN ROUND(count * 100.0 / NULLIF((SELECT count FROM population_counts WHERE population_type = 'denominator'), 0), 2) ELSE NULL END AS percentage FROM population_counts ORDER BY sort_order",
      "viewName": "cms125_measure_report"
    }
  ]
}
